# R for travis: see documentation at https://docs.travis-ci.com/user/languages/r

language: r


# matrix ====

r:
  - oldrel
  - release
  - devel

os:
  - linux
  - osx

matrix:
  allow_failures:
    - os: osx


# general settings ====

warnings_are_errors: true

cache:
  packages: yes
  directories:
    - $HOME/bin
    - $TRAVIS_BUILD_DIR/docs/book/_bookdown_files


notifications:
  email: false
  slack: sozhoh:P4zamVjBWAc8J0DpwsOyCiqC


# linux stuff ====

dist: trusty

sudo: false

addons:
  apt:
    packages:
      - pdf2svg


# macOS stuff ====

disable_homebrew: false

brew_packages:
  - openssl
  - pandoc


# INSTALL ====
# part of R default

git:
  submodules: false

before_install:
  - echo -e "machine github.com\n  login $GITHUB_PAT" >> ~/.netrc
  - git submodule update --init

# SCRIPT ====
# part of r default


before_deploy:
  - Rscript -e 'covr::codecov()'
  - R CMD INSTALL .
  - Rscript -e 'blogdown::install_hugo()'
  - Rscript -e 'pensieve:::render_site2()'
  - npm install netlify-cli -g
  - Rscript -e "rsconnect::setAccountInfo(name='maxheld83', token='${SHINYAPPS_TOKEN}', secret='${SHINYAPPS_SECRET}')"

deploy:
  - provider: script
    script: netlify deploy -s pensieve.netlify.com -t ${NETLIFY_PAT} -e production
    skip_cleanup: true
    on:
      branch: master
      condition: "$TRAVIS_OS_NAME = linux && $TRAVIS_R_VERSION_STRING = release"
  - provider: script
    script: Rscript -e "rsconnect::deployApp(appDir = 'inst/accio/', account = 'maxheld83', appName = 'accio')"
    skip_cleanup: true
    on:
      branch: master
      condition: "$TRAVIS_OS_NAME = linux && $TRAVIS_R_VERSION_STRING = release"
  - provider: pages
    github_token: $GITHUB_PAT
    local_dir: _site/
    skip_cleanup: true
    on:
      branch: master
      condition: "$TRAVIS_OS_NAME = linux && $TRAVIS_R_VERSION_STRING = release"

